# Matching users to destinations based on travel time

In this tutorial, we show you how to use Radar's [Search Users](https://radar.com/documentation/api#search-users) and [Distance Matrix](https://radar.com/documentation/api#matrix) endpoints to find the nearest users to a known destination, sorted by travel time.

This tutorial is most applicable for proximity-based job assignment including matching a driver to a delivery or matching a professional to a job.

Leveraging user location to influence job assignment can significantly reduce travel time and better optimize job allocations, making end user workflows more efficient.

## Languages used
- JavaScript

## Features used
- SDK
- [Search Users API](https://radar.com/documentation/api#search-users)
- [Distance Matrix API](https://radar.com/documentation/api#matrix)

## Steps
1. Configure tracking with SDK: Ensure background location permissions have been granted and start Radar SDK tracking in the responsive tracking preset ([iOS](https://radar.com/documentation/sdk/ios#background-tracking-for-geofencing) & [Android](https://radar.com/documentation/sdk/android#background-tracking-for-geofencing).

<Tabs
  groupId="ios"
  defaultValue="swift"
  values={[
    { label: 'Swift', value: 'swift' },
    { label: 'Objective-C', value: 'objc' }
  ]}
>
  <TabItem value="swift">

```swift
Radar.startTracking(trackingOptions: RadarTrackingOptions.presetResponsive)
```

  </TabItem>
  <TabItem value="objc">

```objc
[Radar startTrackingWithOptions:RadarTrackingOptions.presetResponsive];
```

  </TabItem>
</Tabs>

<Alert alertType="warning">
  Ensure tracking has been activated by verifying that users are populating on the Users page in the dashboard (users will populate on the users page once tracking has successfully started on the device).
</Alert>

2. Get drive times for user sorting/prioritization: Two separate Radar APIs will be used:
   - Retrieve users nearby the job location. Search users API reference: [Search Users API](https://radar.com/documentation/api#search-users)
   - Retrieve drive times for nearby users to prioritize based on drive time. Distance Matrix reference: [Distance Matrix API](https://radar.com/documentation/api#matrix)

Below is sample node.js code showing how to call Radar APIs and return nearby user results sorted based on drive time. Note that this workflow assumes you have the location of the job - if you do not, you can optionally also call Radar's Forward Geocode endpoint to fetch lat/lng from a job address ([Forward Geocode API](https://radar.com/documentation/api#forward-geocode)):

```javascript
import got from 'got';

const radarSearchUsersUrl = 'https://api.radar.io/v1/search/users';
const radarDistanceMatrixUrl = 'https://api.radar.io/v1/route/matrix';

// destination = job_site
const destination = {
  latitude: 40.7343726,
  longitude: -73.9912144
};

const options = {
  headers: {
    'Authorization': '<testRadarSecretKey>'
  }
};

const searchUsersResponse = await got.get(`${radarSearchUsersUrl}?near=${destination.latitude},${destination.longitude}&radius=10000&limit=100`, options).json()

if (searchUsersResponse.meta.code === 200) {
  if (searchUsersResponse.users.length > 0) {
    const users = searchUsersResponse.users;

    // store index position sent to distance matrix API for sorted retrieval    
   const usersPositions = users.map((user, i) => ({ radarId: user._id,  userId: user.userId, idx: i, coordinates: user.location.coordinates }))

    const originsString = users.map(user => `${user.location.coordinates[1]},${user.location.coordinates[0]}`).join("|");
    const destinationString = `${destination.latitude},${destination.longitude}`
    const distanceMatrixResponse = await got.get(`${radarDistanceMatrixUrl}?origins=${originsString}&destinations=${destinationString}&mode=car&units=imperial`, options).json()
    // sort matrix response based on duration (shortest to longest) and get index position
    const userDurationSortedIndex = distanceMatrixResponse.matrix.flat().sort((a, b) => a.duration.value - b.duration.value).map((userDuration) => userDuration.originIndex);

    const userDrivingDistancePositions = {};
    for (const [index, id] of userDurationSortedIndex.entries()) {
      userDrivingDistancePositions[id] = index;
    }
    const usersSorted = usersPositions.sort((a, b) => userDrivingDistancePositions[a.idx] - userDrivingDistancePositions[b.idx]);

    // log users sorted by drive time to job site 
    console.log(usersSorted)
  }
}
